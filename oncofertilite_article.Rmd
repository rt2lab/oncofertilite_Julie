---
title: "oncofertilite_article"
author: "Anne-Sophie HAMY-PETIT"
# date: "`r format(Sys.time(), "%d %B, %Y")`"
output:
  word_document:
    toc: yes
  html_document:
    fig_caption: yes
    number_sections: yes
    theme: cerulean
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: no
editor_options:
  chunk_output_type: console
chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE,cache=FALSE,message=FALSE,warning=FALSE,include=TRUE, prompt=TRUE, tidy=TRUE)
```

```{r Loadpkgs,cache=FALSE,include=FALSE}

options(max.print = 9999)
options(stringsAsFactors=FALSE)
options(dplyr.print_max = Inf)

rm(list = ls())
getwd()
require(xlsx)
require(tableone)
require(ggsci)
require(stringr)
require(tidyverse)
require(ggplot2)
require(reshape2)
require(gridExtra)
require(cowplot)
require(xtable)
require(knitr)
require(gProfileR)
  	 # setwd("~/RT2Lab/oncofertilite/oncofertilite_2011_2017")
load(file="/Users/ahamypet/RT2Lab/oncofertilite/oncofertilite_2011_2017/data/processed/mat_globale.RData")
```


```{r}
# question oktay
mat_globale$Mutation_bin <- ifelse(mat_globale$Mutation %in% c("BRCA1","BRCA2"),"BRCA","no, others or NA")

head(mat_globale)
mat_globale$Mutation
mat_globale %>% select(AMH,date_prelevement_AMH,Mutation)
mat_globale %>% filter(!is.na(AMH)) %>% nrow() # 221
mat_globale %>% filter(!is.na(AMH)) %>% group_by(Mutation_bin) %>% count() # 221
mat_globale %>% filter(!is.na(AMH)) %>% group_by(Mutation) %>% count() # 221

mat_globale %>% group_by((Mutation_bin)) %>% count() # 135 BRCA
mat_globale %>% group_by((Mutation)) %>% count() # 221

```


# Patients and tumor characteristics
`r nrow(mat_globale) ` patients were included in the analyses.
Median age was 38.8 y.o.Â [22-43]

```{r, include=FALSE}
    median(mat_globale$age, na.rm = T)
    range(mat_globale$age, na.rm = T)
```
The number of patients increased with increasing age.

```{r, include=FALSE}
load(file="data/processed/p_age_at_diag_4classes.RData")
```

```{r,fig.height=6,fig.width=6}
p_age_at_diag_4classes
```

The distribution by age class was as follows (%).
```{r}
round(prop.table(table(mat_globale$age_cl))*100,1) # Les %
253+99

```

# Fertility preservation procedures
## Fertility preservation discussion
Fertility preservation procedures were more likely to be discussed with younger and nulliparous women.
FP proposal increased over time, but reached a plateau after 2015. 

```{r,include=FALSE}
load(file="data/processed/p_FP_proposal_by_age.RData")
load(file="data/processed/p_FP_proposal_by_parity.RData")
load(file="data/processed/p_FP_refusal_by_age.RData")
load(file="data/processed/p_FP_refusal_by_nb_children.RData")
load(file="data/processed/p_FP_proposal_by_year_diag.RData")
```

```{r,fig.height=6,fig.width=10}
p_FP_proposal_by_age
p_FP_proposal_by_parity
p_FP_proposal_by_year_diag
```

Fertility preservation procedures (FPP) were discussed with 450 women.
Patient refusal increased with increasing age, and with increasing number of children before BC diagnosis.

```{r,fig.height=6,fig.width=10}
p_FP_refusal_by_age
p_FP_refusal_by_nb_children
```


## Fertility preservation realisation

14 women were pregnant at diagnosis and did not undergo FP.

```{r, include=FALSE}
table(mat_globale$enceinte_au_diag, exclude=NULL)
```


On 450 who had fertility discussion, 258 patients (57.3%) had at least one fertility procedure methods.

Patients who underwent FP procedure were different from patients who did not.
all_caract_by_PF_or_not.xlsx
They were younger, more likely to be nulliparous, BRCA mutated, and to undergo NAC.


### Delays 
Mean delay from diagnosis to chemotherapy was significantly lower in patients with NAC than in  patients with adjuvant chemotherapy (23.8 versus 70.0 days, p<0.001) .

```{r,include=FALSE}
load( file="data/processed/p_delay_diag_chimio.RData")
load(file="data/processed/p_delay_diag_chimio_by_PF.RData")

```

```{r}
p_delay_diag_chimio
```

Delays from time from diagnosis to chemotherapy were not significantly different in patients who had fertility preservation than those who did not, neither in patients with NAC (no PF: 24.1 days versus PF: 22.8, p=0.24) 
nor in patients with adjuvant chemotherapy (no PF: 70.6 days versus PF :66.8 days, p=0.11).

```{r,fig.height=9,fig.width=9}
p_delay_diag_chimio_by_PF

```

### Type of FP procedure

```{r, include=FALSE}
mat_globale %>% filter (!is.na(pf_type_2)) %>% nrow()
load(file="data/processed/p_type_stim.RData")
258/450
```

```{r,fig.height=6,fig.width=6}
             # MIV Others   STIM 
             # 154     22     81 
table(mat_globale$pf_type_2)
round(prop.table(table(mat_globale$pf_type_2))*100,1) # Les %

p_type_stim

```


```{r}
load(file="data/processed/p_methods_pf_fn_CNA.RData")
```

```{r repartition FP by neoadj et adj,fig.height=6,fig.width=8}
p_methods_pf_fn_CNA
```

## Biological parameters

```{r}
length(which(!is.na(mat_globale$AMH_2)))
length(which(!is.na(mat_globale$CFA_2)))
```

Baseline AMH and CFA were available for `r length(which(!is.na(mat_globale$AMH_2))) ` and `r length(which(!is.na(mat_globale$CFA_2))) ` patients respectively.

AMH and CFA decreased significantly with advancing age (Fig xx A and B), but the correlation coefficient was weak (Figure C and D) (r=-0.20,p=0.004 and r=-0.19, p=0.004 )

```{r, include=FALSE}
load(file="data/processed/plot_AMH_CFA_age.RData")
    # cor.test(mat_globale$age, mat_globale$AMH_2) # -0.20, p=0.004
    # cor.test(mat_globale$age, mat_globale$CFA_2) # -0.19, p=0.004
    # cor.test(mat_globale$AMH_2, mat_globale$CFA_2) # 0.69, p=10-16

```

```{r,fig.height=9,fig.width=9}
plot_AMH_CFA_age
```

```{r,include=FALSE}
load( file="data/processed/p_CFA_AMH.RData")
```

AMH and CFA were strongly correlated.

```{r,fig.height=4,fig.width=4}
p_CFA_AMH
```


## Return rate
 
On 218 ??? patients with material available, 5 return to one of the ART centers (STIM n=2, MIV n=2) and used frozen material (oocytes n=2, embryo n=2, NA n=1) .
One patient had a subsequent pregnancy but experienced a miscarriage.


## Pregnancies 
40 patients had at least one pregnancy following BC (1 pregnancy n=32; 2 pregnancies n=7 ; 3 pregnancies n=1 ).

Out of 47 pregnancies, 39 were spontaneous, 7 were obtained with egg donation, and one with the frozen material derived from FP procedure.

Pregnancies outcomes  were live births (43%, n=21) or ongoing prengnancies (n=8, 16%), miscarriages (20%, n=10), induced abortions (10%, n= 5), or outcome not mentionned (10%, n= 5).

```{r, include=FALSE}
load(file="data/processed/mat_globale_all_pregnancies.RData")
load(file="data/processed/p_preg_outcome.RData")
load(file="data/processed/preg_outcome.RData")
preg_outcome
mat_globale_all_pregnancies %>% nrow() # 49
mat_globale_all_pregnancies %>% group_by(nip7) %>% summarise(count=n()) %>%
                                                group_by(count)%>% summarise(count2=n()) 
preg_spontaneous
```


```{r,fig.height=4,fig.width=7}
p_preg_outcome
```

